apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: "test@test.com"
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: nginx




db.collection_name.aggregate([
  {
    $project: {
      sizeInMB: { $divide: [{ $bsonSize: "$$ROOT" }, 1024 * 1024] },
    },
  },
  {
    $match: {
      sizeInMB: { $gte: YOUR_SIZE_THRESHOLD },
    },
  },
  {
    $sort: {
      sizeInMB: -1,
    },
  },
]);


db.collection_name.updateMany(
  { "controlsApplied.effectiveDate": { $exists: true } },
  [
    {
      $set: {
        controlsApplied: {
          $map: {
            input: "$controlsApplied",
            as: "control",
            in: {
              $mergeObjects: [
                "$$control",
                {
                  effectiveDate: {
                    $cond: {
                      if: { $ne: ["$$control.effectiveDate", undefined] },
                      then: { $toDate: "$$control.effectiveDate" },
                      else: "$$control.effectiveDate",
                    },
                  },
                },
              ],
            },
          },
        },
      },
    },
  ]
);

db.yourCollectionName.updateMany(
  {
    "controlsApplied.effectiveDate": { $exists: true }
  },
  [
    {
      $set: {
        "controlsApplied": {
          $map: {
            input: "$controlsApplied",
            as: "control",
            in: {
              $mergeObjects: [
                "$$control",
                {
                  $cond: [
                    { $eq: ["$$control.effectiveDate", { $exists: false }] },
                    {},
                    { "effectiveDate": { $toDate: "$$control.effectiveDate" } }
                  ]
                }
              ]
            }
          }
        }
      }
    }
  ]
);

db.collection_name.updateMany(
    { "controlsApplied.effectiveDate": { $exists: true } },
    [
        {
            $set: {
                controlsApplied: {
                    $map: {
                        input: "$controlsApplied",
                        as: "control",
                        in: {
                            $mergeObjects: [
                                "$$control",
                                {
                                    effectiveDate: {
                                        $cond: {
                                            if: { $eq: ["$$control.effectiveDate", null] },
                                            then: null,
                                            else: {
                                                $convert: {
                                                    input: "$$control.effectiveDate",
                                                    to: "date",
                                                    onError: null
                                                }
                                            }
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        }
    ]
);


db.collection_name.updateMany(
    { "controlsApplied.country.effectiveDate": { $exists: true } },
    [
        {
            $set: {
                controlsApplied: {
                    $map: {
                        input: "$controlsApplied",
                        as: "control",
                        in: {
                            $mergeObjects: [
                                "$$control",
                                {
                                    country: {
                                        $mergeObjects: [
                                            "$$control.country",
                                            {
                                                effectiveDate: {
                                                    $cond: {
                                                        if: { $eq: ["$$control.country.effectiveDate", null] },
                                                        then: null,
                                                        else: {
                                                            $convert: {
                                                                input: "$$control.country.effectiveDate",
                                                                to: "date",
                                                                onError: null
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        }
    ]
);


db.collection_name.updateMany(
    { "controlsApplied.country.effectiveDate": { $exists: true } },
    [
        {
            $set: {
                controlsApplied: {
                    $map: {
                        input: "$controlsApplied",
                        as: "control",
                        in: {
                            $mergeObjects: [
                                "$$control",
                                {
                                    country: {
                                        $mergeObjects: [
                                            "$$control.country",
                                            {
                                                effectiveDate: {
                                                    $cond: {
                                                        if: { $eq: ["$$control.country.effectiveDate", null] },
                                                        then: null,
                                                        else: {
                                                            $convert: {
                                                                input: "$$control.country.effectiveDate",
                                                                to: "date",
                                                                onError: null
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        }
    ]
);



db.collection_name.updateMany(
    { "controlsApplied.country.effectiveDate": { $exists: true } },
    [
        {
            $set: {
                controlsApplied: {
                    $map: {
                        input: "$controlsApplied",
                        as: "control",
                        in: {
                            $mergeObjects: [
                                "$$control",
                                {
                                    country: {
                                        $cond: {
                                            if: { $isObject: "$$control.country" },
                                            then: {
                                                $mergeObjects: [
                                                    "$$control.country",
                                                    {
                                                        effectiveDate: {
                                                            $cond: {
                                                                if: { $eq: ["$$control.country.effectiveDate", null] },
                                                                then: null,
                                                                else: {
                                                                    $convert: {
                                                                        input: "$$control.country.effectiveDate",
                                                                        to: "date",
                                                                        onError: null
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                ]
                                            },
                                            else: "$$control.country"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        }
    ]
);
